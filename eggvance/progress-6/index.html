<!DOCTYPE html><html lang="en-US"><head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Julian Smolka">
<meta name="description" content="The sixth progress report of the eggvance GBA emulator.">
<link rel="canonical" href="https://smolka.dev/eggvance/progress-6/">

<link rel="preload" href="/static/font/roboto/roboto-400.woff2" as="font" type="font/woff2" crossorigin="">
<link rel="preload" href="/static/font/roboto/roboto-700.woff2" as="font" type="font/woff2" crossorigin="">
<link rel="preload" href="/static/font/roboto-mono/roboto-mono-400.woff2" as="font" type="font/woff2" crossorigin="">


<link rel="stylesheet" href="https://smolka.dev/css/main.min.c8e683b5c411ba8932e72eec996baa206a0fe7f54c69e498864b10de0da64898.css">

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#42a5f5">
<meta name="msapplication-TileColor" content="#42a5f5">
<meta name="theme-color" content="#212121">


<title>Progress Report #6</title>




  
  <script type="text/javascript" src="https://smolka.dev/js/alpine.js" defer=""></script>



  
  <script type="text/javascript" src="https://smolka.dev/js/headroom.js" async=""></script>



  </head>
  <body x-data="{ menu: false }" :class="{ 'overflow-hidden': menu }" class="flex flex-col min-w-screen min-h-screen m-0 p-0 font-body bg-white text-gray-900">
    <header class="fixed top-0 z-10 w-full bg-gray-900 text-gray-50 shadow-header select-none">
  <nav class="flex justify-between max-w-screen-xl mx-auto">
    <div class="mr-4">
      <a class="flex items-center h-18 px-4" href="https://smolka.dev/">
        <div class="h-8">
          <svg class="h-full" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 -0.5 92 16" shape-rendering="crispEdges">
  <path stroke="#000000" d="M4 0h2M11 0h2M3 1h1M6 1h1M10 1h1M13 1h1M2 2h1M6 2h1M9 2h1M13 2h1M2 3h1M7 3h1M9 3h1M14 3h1M22 3h9M34 3h9M46 3h9M58 3h6M70 3h9M82 3h9M1 4h1M8 4h1M14 4h1M22 4h1M30 4h2M34 4h1M39 4h1M42 4h2M46 4h1M54 4h2M58 4h1M63 4h1M70 4h1M75 4h1M78 4h2M82 4h1M90 4h2M1 5h1M9 5h2M14 5h1M22 5h1M31 5h1M34 5h1M39 5h1M43 5h1M46 5h1M55 5h1M58 5h1M63 5h1M70 5h1M75 5h1M79 5h1M82 5h1M91 5h1M0 6h1M11 6h2M15 6h1M22 6h1M31 6h1M34 6h1M39 6h1M43 6h1M46 6h1M55 6h1M58 6h1M63 6h1M70 6h1M75 6h1M79 6h1M82 6h1M91 6h1M0 7h2M13 7h3M22 7h1M31 7h1M34 7h1M39 7h1M43 7h1M46 7h1M55 7h1M58 7h1M63 7h1M70 7h1M75 7h1M79 7h1M82 7h1M91 7h1M0 8h1M2 8h2M8 8h2M13 8h1M15 8h1M22 8h1M28 8h4M34 8h1M39 8h1M43 8h1M46 8h1M51 8h1M55 8h1M58 8h1M63 8h1M70 8h1M75 8h1M79 8h1M82 8h1M87 8h1M91 8h1M0 9h1M4 9h1M6 9h2M10 9h1M12 9h1M15 9h1M22 9h1M31 9h1M34 9h1M39 9h1M43 9h1M46 9h1M51 9h1M55 9h1M58 9h1M63 9h5M70 9h1M78 9h2M82 9h1M91 9h1M0 10h1M5 10h1M11 10h1M15 10h1M22 10h6M31 10h1M34 10h1M43 10h1M46 10h1M51 10h1M55 10h1M58 10h1M63 10h1M67 10h1M70 10h1M75 10h1M79 10h1M82 10h1M87 10h1M91 10h1M1 11h1M14 11h1M22 11h1M31 11h1M34 11h1M38 11h1M40 11h1M43 11h1M46 11h1M55 11h1M58 11h1M67 11h1M70 11h1M75 11h1M79 11h1M82 11h1M87 11h1M91 11h1M1 12h1M14 12h1M22 12h10M34 12h10M46 12h10M58 12h10M70 12h10M82 12h10M2 13h2M12 13h2M4 14h2M10 14h2M6 15h4"></path>
  <path stroke="#26C6DA" d="M4 1h2M11 1h2M3 2h3M10 2h3M3 3h1M5 3h2M10 3h1M12 3h2M2 4h2M6 4h2M9 4h2M13 4h1M2 5h1M7 5h2M13 5h1M1 6h2M8 6h3M13 6h2M2 7h1M10 7h3M12 8h1"></path>
  <path stroke="#3CCCDE" d="M4 3h1M11 3h1M4 4h2M11 4h2M3 5h4M11 5h2M3 6h1M6 6h2M3 7h1M7 7h3M10 8h2M11 9h1"></path>
  <path stroke="#FAFAFA" d="M23 4h7M35 4h4M40 4h2M47 4h7M59 4h4M71 4h4M76 4h2M83 4h7M23 5h8M35 5h4M40 5h3M47 5h8M59 5h4M71 5h4M76 5h3M83 5h8M23 6h8M35 6h4M40 6h3M47 6h8M59 6h4M71 6h4M76 6h3M83 6h8M23 7h8M35 7h4M40 7h3M47 7h8M59 7h4M71 7h4M76 7h3M83 7h8M23 8h5M35 8h4M40 8h3M47 8h4M52 8h3M59 8h4M71 8h4M76 8h3M83 8h4M88 8h3M23 9h8M35 9h4M40 9h3M47 9h4M52 9h3M59 9h4M71 9h7M83 9h8M28 10h3M35 10h8M47 10h4M52 10h3M59 10h4M64 10h3M71 10h4M76 10h3M83 10h4M88 10h3M23 11h8M35 11h3M39 11h1M41 11h2M47 11h8M59 11h8M71 11h4M76 11h3M83 11h4M88 11h3"></path>
  <path stroke="#51D1E2" d="M4 6h2M4 7h3M4 8h1M6 8h2"></path>
  <path stroke="#212121" d="M1 8h1M1 9h3M1 10h4M2 11h3M2 12h3M4 13h2"></path>
  <path stroke="#67D7E6" d="M5 8h1M5 9h1"></path>
  <path stroke="#424242" d="M14 8h1M13 9h2M13 10h2"></path>
  <path stroke="#323232" d="M8 9h2M8 10h3M8 11h3M9 12h2M9 13h3"></path>
  <path stroke="#292929" d="M6 10h2M5 11h3M5 12h4M6 13h3M6 14h4"></path>
  <path stroke="#3A3A3A" d="M12 10h1M11 11h3M11 12h3"></path>
</svg>

        </div>
      </a>
    </div>
    <div class="ml-4">
      <div class="sm:flex hidden hover:text-gray-500">
        
          <a class="flex items-center h-18 px-4 hover:text-gray-50" href="https://smolka.dev/about">
            
            <div class="relative inline-flex flex-col justify-center h-full">
              <span>About</span>
              <span class="absolute bottom-0 h-0 w-full bg-gray-50"></span>
            </div>
          </a>
        
          <a class="flex items-center h-18 px-4 hover:text-gray-50" href="https://smolka.dev/cycling">
            
            <div class="relative inline-flex flex-col justify-center h-full">
              <span>Cycling</span>
              <span class="absolute bottom-0 h-0 w-full bg-gray-50"></span>
            </div>
          </a>
        
          <a class="flex items-center h-18 px-4 hover:text-gray-50" href="https://smolka.dev/eggvance">
            
            <div class="relative inline-flex flex-col justify-center h-full">
              <span>Eggvance</span>
              <span class="absolute bottom-0 nav-item-animation h-1 w-full bg-gray-50"></span>
            </div>
          </a>
        
      </div>
      <div class="flex sm:hidden">
        <button :class="{ 'is-active': menu }" @click="menu = !menu" class="hamburger hamburger--squeeze h-18 focus:outline-none">
          <span class="hamburger-box align-middle">
            <span class="hamburger-inner"></span>
          </span>
        </button>
      </div>
    </div>
  </nav>
</header>
<div class="aboslute top-0 min-h-18 w-full bg-gray-900"></div>
<div x-cloak="" x-show="menu" class="mobile-menu block sm:hidden w-full bg-gray-900 text-gray-50 overflow-y-auto shadow-header select-none">
  <div class="flex flex-col mb-4 hover:text-gray-500">
    
      <a class="flex justify-center items-center h-18 hover:text-gray-50" href="https://smolka.dev/about">About</a>
    
      <a class="flex justify-center items-center h-18 hover:text-gray-50" href="https://smolka.dev/cycling">Cycling</a>
    
      <a class="flex justify-center items-center h-18 hover:text-gray-50" href="https://smolka.dev/eggvance">Eggvance</a>
    
  </div>
</div>
<noscript class="w-full px-4 py-3 bg-gray-900 text-gray-50 text-center">
  This site works better with JavaScript enabled (it's just ~10kb).
</noscript>

    
  <div class="w-full px-4 py-8 sm:py-16 bg-gray-900">
    <div class="flex flex-col text-center">
      <span class="max-w-screen-lg mx-auto mb-2 text-gray-50 text-4xl">Progress Report #6</span>
      <span class="max-w-screen-sm mx-auto text-gray-400">The sixth progress report of the eggvance GBA emulator.</span>
    </div>
  </div>
  <div class="w-full max-w-screen-md mx-auto px-4 py-8 sm:py-16">
    <div class="single">
      <p>2020 came to an end and left me with an output of two progress reports and a simple, short release note. That's less than I was hoping for, but the most time this year went into improving the code base and some performance tinkering for personal pleasure. In my defense, the last progress report had much higher quality than the previous ones, and I'd like to keep it this way!</p>
<h3 id="undefined-behavior">
  <a href="#undefined-behavior">Undefined Behavior</a>
</h3>
<p>In that spirit, let's start with an <a href="https://github.com/jsmolka/eggvance/issues/4" target="_blank" rel="noopener">issue</a> which has been reported by fleroviux in June last year. He tried to play Pok√©mon Sapphire and his game froze right after the intro sequence when the character shrinks in size and then enters the world in a moving truck. The same also happens in Ruby because they are essentially the same game.</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/sapphire-bad-bios-bug.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/sapphire-bad-bios-bug.png" alt="Figure 1: Freezing during intro sequence" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 1: Freezing during intro sequence</figcaption>
    
  </figure>


  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/sapphire-bad-bios.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/sapphire-bad-bios.png" alt="Figure 2: In the truck where we belong" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 2: In the truck where we belong</figcaption>
    
  </figure>



</div>

<p>He used the bundled replacement BIOS made by Normmatt where bugs in games are to be expected. I tried it with the original one, and the freezing stopped happening. So I closed the issue and blamed the BIOS for doing some unexpected things, but he quickly reassured me that the bug wasn't happening in his emulator or mGBA when using the same BIOS. I verified that and was left scratching my head about the possible origin of this problem.</p>
<p>I figured it had something to do with the BIOS implementation but I couldn't find anything wrong with it. Many failed attempts later GitHub suggested me the <a href="https://github.com/pret" target="_blank" rel="noopener">pret</a> project which is the decompilation of all GB, GBA, and even some NDS Pok√©mon games. I can't believe how people do such things but I'll gladly use their work to fix bugs in my emulator. I skimmed through the intro-sequence related parts of the code and <a href="https://github.com/pret/pokeruby/blob/c7bbd485c3103c6a51d15f6e0081922d3c14d42d/src/fieldmap.c#L87" target="_blank" rel="noopener">this function</a>:</p>
<pre class=" language-c"><code class=" language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">InitBackupMapLayoutConnections</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">MapHeader</span> <span class="token operator">*</span>mapHeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> count <span class="token operator">=</span> mapHeader<span class="token operator">-&gt;</span>connections<span class="token operator">-&gt;</span>count<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">MapConnection</span> <span class="token operator">*</span>connection <span class="token operator">=</span> mapHeader<span class="token operator">-&gt;</span>connections<span class="token operator">-&gt;</span>connections<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  gMapConnectionFlags <span class="token operator">=</span> sDummyConnectionFlags<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> connection<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Handle</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>At first glance, there seems to be nothing wrong this it, but this comment doesn't agree:</p>
<blockquote>
<p>BUG: This results in a null pointer dereference when <code>mapHeader-&gt;connections</code> is <code>NULL</code>, causing count to be assigned a garbage value. This garbage value just so happens to have the most significant bit set, so it is treated as negative and the loop below thankfully never executes in this scenario.</p>
</blockquote>
<p>I never ran into this bug during testing because it has been fixed in <a href="https://github.com/pret/pokeemerald/blob/64460e01aede2bbcaa8d1dd18dd3fab590fa4a6e/src/fieldmap.c#L114" target="_blank" rel="noopener">Pok√©mon Emerald</a>, and that's the game I usually use for quick testing (and pure nostalgia). The dereferenced null pointer returns something they call garbage, which is quite offensive to the poor BIOS in my opinion. Why the BIOS? Because it starts at address 0, and that's where a dereferenced null pointer reads from.</p>
<pre class=" language-none"><code class=" language-none">00000000-00003FFF   BIOS - System ROM
00004000-01FFFFFF   Not used
02000000-0203FFFF   WRAM - On-board Work RAM
02040000-02FFFFFF   Not used
03000000-03007FFF   WRAM - On-chip Work RAM
03008000-03FFFFFF   Not used
04000000-040003FE   I/O Registers
04000400-04FFFFFF   Not used
</code></pre>
<p>The BIOS in the Game Boy Advance is read-protected to prevent dumping (guess how that turned out). It means that we can only read from the BIOS if the program counter is inside of it. Otherwise, it will return the last read value, which will be the one located at address</p>
<ul>
<li>0x0DC+8 after startup</li>
<li>0x188+8 after SWI</li>
<li>0x134+8 during IRQ</li>
<li>0x13C+8 after IRQ</li>
</ul>
<p>In the case of our dereferenced null pointer, we've just returned from a SWI. The code for this in the original BIOS looks like the following:</p>
<pre class=" language-armv4t"><code class=" language-armv4t"><span class="token function">movs</span>      <span class="token keyword">pc</span>, <span class="token keyword">lr</span>          <span class="token comment">; addr: 00000188  data: E1B0F00E</span>
<span class="token function">mov</span>       <span class="token keyword">r12</span>, <span class="token number">0x4000000</span>  <span class="token comment">; addr: 0000018C  data: E3A0C301</span>
<span class="token function">mov</span>       <span class="token keyword">r2</span>, <span class="token number">0x4</span>         <span class="token comment">; addr: 00000190  data: E3A02004</span>
</code></pre>
<p>It uses the instruction <code>movs pc, lr</code> to move the link register into the program counter. The link register contains the next instruction after a function call, so it pretty much acts like your typical <code>return</code>. Because of the GBAs two staged instruction pipeline, we've already fetched the value at address 0x190, and its value will be returned for future protected BIOS reads (like dereferenced null pointers). In this case, the value has its sign bit set and the loop is never executed.</p>
<pre class=" language-armv4t"><code class=" language-armv4t"><span class="token function">movs</span>      <span class="token keyword">pc</span>, <span class="token keyword">lr</span>                <span class="token comment">; addr: 000000AC  data: E1B0F00E</span>
<span class="token function">andeq</span>     <span class="token keyword">r1</span>, <span class="token keyword">r0</span>, <span class="token keyword">r4</span>, <span class="token function">lsl</span> <span class="token number">0x10</span>  <span class="token comment">; addr: 000000B0  data: 00001804</span>
<span class="token function">andeq</span>     <span class="token keyword">r1</span>, <span class="token keyword">r0</span>, <span class="token keyword">r4</span>, <span class="token function">lsr</span> <span class="token number">0xA</span>   <span class="token comment">; addr: 000000B4  data: 00001524</span>
</code></pre>
<p>Unfortunately, the replacement BIOS doesn't reproduce this behavior. Here we return with the same instruction, but the prefetched value now is positive and we run the loop 1524 times. I thought this was the source of the problem, but it wasn't. Until this point, the emulator did every correctly and the bug hunt ended with an anticlimactic result.</p>
<p>I fixed the bug when working on something completely different. Reads from unused memory regions return values based on prefetched values in the CPUs pipeline. There were some small issues in that code that were fixed in <a href="https://github.com/jsmolka/eggvance/commit/213c7ab0a18502125b725536c433da3bf90d0b84" target="_blank" rel="noopener">this commit</a>. It seems that the game tries to access unused memory regions at some point when running the loop with the wrong loop counter and returning 'proper bad value' fixes the freezing behavior.</p>
<h3 id="sprite-render-cycles">
  <a href="#sprite-render-cycles">Sprite Render Cycles</a>
</h3>
<p>This <a href="https://github.com/jsmolka/eggvance/issues/2" target="_blank" rel="noopener">issue</a> was quite a simple fix compared to the previous one and has also been reported by fleroviux. The total available render cycles for sprites are 1210 if the H-Blank interval free bit in the display control register is set or 954 otherwise. This means that the amount of sprites per scanline is limited. If you ignore that limit you get something like in figure 3, where the sprite on top overlaps with the status bar.</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/gunstar-sprite-cycles-bug.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/gunstar-sprite-cycles-bug.png" alt="Figure 3: Gunstar Super Heroes without render cycles" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 3: Gunstar Super Heroes without render cycles</figcaption>
    
  </figure>


  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/gunstar-sprite-cycles.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/gunstar-sprite-cycles.png" alt="Figure 4: Gunstar Super Heroes with render cycles" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 4: Gunstar Super Heroes with render cycles</figcaption>
    
  </figure>



</div>

<p>Calculating the number of cycles it takes to render a sprite is quite easy. It takes <code>width</code> cycles for normal and <code>2 * width + 10</code> cycles for sprites with affine transformations. Sprites with x-coordinates outside of the screen also affect this quota and programmers should be mindful to explicitly disable sprites instead of moving them outside the screen.</p>
<h3 id="real-time-clock">
  <a href="#real-time-clock">Real-Time Clock</a>
</h3>
<p>The next thing I want to talk about is an actual new feature in the emulator. If you own a third generation Pok√©mon game and start it, you will notice that it complains about a drained battery. Time based events will no longer work because its internal real-time clock ran dry.</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/emerald-bad-rtc.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/emerald-bad-rtc.png" alt="Figure 5: Empty battery warning" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 5: Empty battery warning</figcaption>
    
  </figure>


  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/emerald-bad-flash.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/emerald-bad-flash.png" alt="Figure 6: Ever saw that back then? (bonus)" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 6: Ever saw that back then? (bonus)</figcaption>
    
  </figure>



</div>

<p>Until now, eggvance perfectly emulated old Pok√©mon cartridges in the sense that both RTCs don't work (it's a feature). The RTC is connected to three of the four GamePak GPIO pins as follows:</p>
<ul>
<li>Serial Clock (SCK) at address 0x80000C4</li>
<li>Serial Input/Output (SIO) at address 0x80000C5</li>
<li>Clock Select (CS) at address 0x80000C6</li>
</ul>
<p>A typical transfer looks like this:</p>
<ul>
<li>Set CS=0 and SCK=1</li>
<li>Wait for a rising CS edge</li>
<li>Receive command byte (described below)</li>
<li>Send / receive command bytes</li>
<li>Wait for a falling CS edge</li>
</ul>
<p>Receiving a command byte looks like this:</p>
<ul>
<li>Wait for a rising SCK edge</li>
<li>Read SIO bit</li>
<li>Repeat until a byte has been transferred</li>
</ul>
<p>Combining these two flows allows us to implement a functioning RTC. The documentation in GBATEK can be quite confusing in that regard because it first describes the NDS RTC and then the differences to GBA one. Once everything has been put into place, I was able to grow berries in the Pok√©mon Emerald.</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/emerald-berry-1.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/emerald-berry-1.png" alt="Figure 7: Berry first stage" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 7: Berry first stage</figcaption>
    
  </figure>


  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/emerald-berry-2.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/emerald-berry-2.png" alt="Figure 8: Berry last stage" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 8: Berry last stage</figcaption>
    
  </figure>



</div>

<p>I later stumbled across a NanoboyAdvance <a href="https://github.com/fleroviux/NanoboyAdvance/issues/136" target="_blank" rel="noopener">issue</a> reported by Robert Peip, which mentions that the RTC doesn't work in Sennen Kazoku. The game boots and then show an error screen mentioning 'broken clock equipment'. I tested it in my emulator and observed the same result.</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/sennen-rtc-bug.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/sennen-rtc-bug.png" alt="Figure 9: Complaining about a bad RTC" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 9: Complaining about a bad RTC</figcaption>
    
  </figure>


  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/sennen-rtc.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/sennen-rtc.png" alt="Figure 10: It works!" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 10: It works!</figcaption>
    
  </figure>



</div>

<p>Debugging the game showed that Sennen Kazoku didn't set SCK high in step one of the transfer sequence. I removed the conditions and then everything worked as expected. Other games with RTCs continued to work with that change, so I kept it.</p>
<pre class=" language-diff-cpp"><code class=" language-diff-cpp"><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span><span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token prefix unchanged"> </span>  <span class="token keyword">case</span> State<span class="token operator">::</span>InitOne<span class="token operator">:</span>
</span><span class="token deleted-sign deleted language-cpp"><span class="token prefix deleted">-</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>port<span class="token punctuation">.</span>cs<span class="token punctuation">.</span><span class="token function">low</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> port<span class="token punctuation">.</span>sck<span class="token punctuation">.</span><span class="token function">high</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="token inserted-sign inserted language-cpp"><span class="token prefix inserted">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>port<span class="token punctuation">.</span>cs<span class="token punctuation">.</span><span class="token function">low</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span>      <span class="token function">setState</span><span class="token punctuation">(</span>State<span class="token operator">::</span>InitTwo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token prefix unchanged"> </span>    <span class="token keyword">break</span><span class="token punctuation">;</span>
</span>
<span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span>  <span class="token comment">// ...</span>
<span class="token prefix unchanged"> </span><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="accuracy-improvements">
  <a href="#accuracy-improvements">Accuracy Improvements</a>
</h3>
<p>I mentioned three remaining things in the last release <a href="/eggvance/release-0.2/">release post</a>: RTC emulation, improved accuracy, and audio. With RTC off the list, there was only one thing left before I could start implementing audio. Even though eggvance is quite accurate, it has some problems in the timing section because <a href="https://mgba.io/2015/06/27/cycle-counting-prefetch/" target="_blank" rel="noopener">prefetch</a> isn't emulated.</p>
<p>Here are some of the things I implemented / changed:</p>
<ul>
<li>DMA bus</li>
<li>Memory improvements</li>
<li>Interrupt delay</li>
<li>Timer delay</li>
<li>Prefetch emulation (not perfect)</li>
</ul>
<p>And the resulting <a href="https://github.com/mgba-emu/suite" target="_blank" rel="noopener">mGBA suite</a> coverage compared to other established emulators:</p>
<div class="my-6 overflow-x-auto">
  <table>
<thead>
<tr>
<th>Test</th>
<th>eggvance 0.2</th>
<th>eggvance 0.3</th>
<th>mGBA 0.8.4</th>
<th>higan v115</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr>
<td>Memory</td>
<td>1456</td>
<td>1552</td>
<td>1552</td>
<td>1552</td>
<td>1552</td>
</tr>
<tr>
<td>I/O read</td>
<td>123</td>
<td>123</td>
<td>114</td>
<td>123</td>
<td>123</td>
</tr>
<tr>
<td>Timing</td>
<td>404</td>
<td>1496</td>
<td>1520</td>
<td>1424</td>
<td>1660</td>
</tr>
<tr>
<td>Timer count-up</td>
<td>365</td>
<td>496</td>
<td>610</td>
<td>449</td>
<td>936</td>
</tr>
<tr>
<td>Timer IRQ</td>
<td>28</td>
<td>65</td>
<td>70</td>
<td>36</td>
<td>90</td>
</tr>
<tr>
<td>Shifter</td>
<td>140</td>
<td>140</td>
<td>132</td>
<td>132</td>
<td>140</td>
</tr>
<tr>
<td>Carry</td>
<td>93</td>
<td>93</td>
<td>93</td>
<td>93</td>
<td>93</td>
</tr>
<tr>
<td>Multiply long</td>
<td>52</td>
<td>52</td>
<td>52</td>
<td>52</td>
<td>72</td>
</tr>
<tr>
<td>DMA</td>
<td>1048</td>
<td>1220</td>
<td>1232</td>
<td>1136</td>
<td>1256</td>
</tr>
<tr>
<td>Edge case</td>
<td>1</td>
<td>2</td>
<td>6</td>
<td>1</td>
<td>10</td>
</tr>
</tbody>
</table>

</div>

<p>I was happy to finally have something you could call relatively cycle accurate. But it came at a cost. Prefetch emulation tanked performance, going from 635 fps in the Pok√©mon Emerald home town down to mere 485 fps. I was shocked, but the issue turned out to be easier than expected. The MSVC optimizer just didn't inline the prefetch code.</p>
<p>That might not sound like a problem until you realize that we are on the hottest of paths out there. It gets called millions of times per second, so eliminating the function call overhead is very important. After force inlining it, I was back at 575 fps which is a nice value. My goal is to finish the emulator at something around 500 fps mark for demanding games (the ones that don't utilize the CPUs halt functionality, I am looking at you GameFreak devs).</p>
<h3 id="sound">
  <a href="#sound">Sound?</a>
</h3>
<p>I really love my writing efficiency. I began this progress report at the start of January, with all the previous topics lined out as bullet points. Then I continued working on my emulator, implemented the FIFO channel relatively quickly, and decided to add it. And then the squares channels. And then the wave channel. And then the noise channel. And now I'm here with a well working APU / DSP, but it never was supposed to be a part of this report.</p>

  
  
  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <audio controls="" preload="metadata">
      <source src="/static/audio/tengoku.mp3" type="audio/mpeg">
    </audio>
    
      <figcaption class="text-center">Audio 1: Intro sequence of Rhythm Tengoku with some nice stereo</figcaption>
    
  </figure>


<p>I'll write another one where I describe some of the sound basics and also give some examples. Most of the GBAs sound is composed of FIFO samples, so it's hard to show all audio channels in action and how they add up into a nice result.</p>
<h3 id="conclusion">
  <a href="#conclusion">Conclusion</a>
</h3>
<p>That's it. I'm done. The roadmap for this year is:</p>
<ul>
<li><del>implement all sound channels</del></li>
<li>optimize sound</li>
<li>implement a scheduler</li>
<li>improve <a href="https://tcrf.net/AGS_Aging_Cartridge" target="_blank" rel="noopener">AGS</a> coverage</li>
<li>implement more features (better config, savestates, whatever)</li>
<li>cleanup the code</li>
</ul>
<p>Then I will put this project to rest and dive into something new. I thought about writing a classic GameBoy emulator, which shouldn't take more than a month because the GBA is a supercharged version of that, and most code could be reused. Another nice thing would be an NES emulator, which was my first console back in the day. I also thought about jumping into NDS emulation, but I'm not sure if I'm good enough for that, we'll see...</p>

    </div>
    <div class="flex justify-between mt-6 pt-6 text-sm text-gray-500 border-t border-gray-300">
      <span class="inline-flex items-center">
        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="currentColor" d="M17 3h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2v2h6V1h2v2zm-2 2H9v2H7V5H4v4h16V5h-3v2h-2V5zm5 6H4v8h16v-8z"></path>
        </svg>
        <span>
          
            2021-02-03
          
        </span>
      </span>
      <a class="inline-flex items-center" href="https://github.com/jsmolka/jsmolka.github.io/tree/master/content/eggvance/progress-6.md" target="_blank">
        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="currentColor" d="M7.05 14.121L4.93 16.243l2.828 2.828L19.071 7.757 16.243 4.93 14.12 7.05l1.415 1.414L14.12 9.88l-1.414-1.415-1.414 1.415 1.414 1.414-1.414 1.414-1.414-1.414-1.415 1.414 1.415 1.414-1.415 1.415L7.05 14.12zm9.9-11.313l4.242 4.242a1 1 0 0 1 0 1.414L8.464 21.192a1 1 0 0 1-1.414 0L2.808 16.95a1 1 0 0 1 0-1.414L15.536 2.808a1 1 0 0 1 1.414 0zM14.12 18.363l1.415-1.414 2.242 2.243h1.414v-1.414l-2.242-2.243 1.414-1.414L21 16.757V21h-4.242l-2.637-2.637zM5.636 9.878L2.807 7.05a1 1 0 0 1 0-1.415l2.829-2.828a1 1 0 0 1 1.414 0L9.88 5.635 8.464 7.05 6.343 4.928 4.929 6.343l2.121 2.12-1.414 1.415z"></path>
        </svg>
        <span>Improve</span>
      </a>
    </div>
  </div>

  

</body></html>