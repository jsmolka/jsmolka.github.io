<!DOCTYPE html><html lang="en-US"><head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Julian Smolka">
<meta name="description" content="The third progress report of the eggvance GBA emulator.">
<link rel="canonical" href="https://smolka.dev/eggvance/progress-3/">

<link rel="preload" href="/static/font/roboto/roboto-400.woff2" as="font" type="font/woff2" crossorigin="">
<link rel="preload" href="/static/font/roboto/roboto-700.woff2" as="font" type="font/woff2" crossorigin="">
<link rel="preload" href="/static/font/roboto-mono/roboto-mono-400.woff2" as="font" type="font/woff2" crossorigin="">


<link rel="stylesheet" href="https://smolka.dev/css/main.min.c8e683b5c411ba8932e72eec996baa206a0fe7f54c69e498864b10de0da64898.css">

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#42a5f5">
<meta name="msapplication-TileColor" content="#42a5f5">
<meta name="theme-color" content="#212121">


<title>Progress Report #3</title>




  
  <script type="text/javascript" src="https://smolka.dev/js/alpine.js" defer=""></script>



  
  <script type="text/javascript" src="https://smolka.dev/js/headroom.js" async=""></script>



  </head>
  <body x-data="{ menu: false }" :class="{ 'overflow-hidden': menu }" class="flex flex-col min-w-screen min-h-screen m-0 p-0 font-body bg-white text-gray-900">
    <header class="fixed top-0 z-10 w-full bg-gray-900 text-gray-50 shadow-header select-none">
  <nav class="flex justify-between max-w-screen-xl mx-auto">
    <div class="mr-4">
      <a class="flex items-center h-18 px-4" href="https://smolka.dev/">
        <div class="h-8">
          <svg class="h-full" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 -0.5 92 16" shape-rendering="crispEdges">
  <path stroke="#000000" d="M4 0h2M11 0h2M3 1h1M6 1h1M10 1h1M13 1h1M2 2h1M6 2h1M9 2h1M13 2h1M2 3h1M7 3h1M9 3h1M14 3h1M22 3h9M34 3h9M46 3h9M58 3h6M70 3h9M82 3h9M1 4h1M8 4h1M14 4h1M22 4h1M30 4h2M34 4h1M39 4h1M42 4h2M46 4h1M54 4h2M58 4h1M63 4h1M70 4h1M75 4h1M78 4h2M82 4h1M90 4h2M1 5h1M9 5h2M14 5h1M22 5h1M31 5h1M34 5h1M39 5h1M43 5h1M46 5h1M55 5h1M58 5h1M63 5h1M70 5h1M75 5h1M79 5h1M82 5h1M91 5h1M0 6h1M11 6h2M15 6h1M22 6h1M31 6h1M34 6h1M39 6h1M43 6h1M46 6h1M55 6h1M58 6h1M63 6h1M70 6h1M75 6h1M79 6h1M82 6h1M91 6h1M0 7h2M13 7h3M22 7h1M31 7h1M34 7h1M39 7h1M43 7h1M46 7h1M55 7h1M58 7h1M63 7h1M70 7h1M75 7h1M79 7h1M82 7h1M91 7h1M0 8h1M2 8h2M8 8h2M13 8h1M15 8h1M22 8h1M28 8h4M34 8h1M39 8h1M43 8h1M46 8h1M51 8h1M55 8h1M58 8h1M63 8h1M70 8h1M75 8h1M79 8h1M82 8h1M87 8h1M91 8h1M0 9h1M4 9h1M6 9h2M10 9h1M12 9h1M15 9h1M22 9h1M31 9h1M34 9h1M39 9h1M43 9h1M46 9h1M51 9h1M55 9h1M58 9h1M63 9h5M70 9h1M78 9h2M82 9h1M91 9h1M0 10h1M5 10h1M11 10h1M15 10h1M22 10h6M31 10h1M34 10h1M43 10h1M46 10h1M51 10h1M55 10h1M58 10h1M63 10h1M67 10h1M70 10h1M75 10h1M79 10h1M82 10h1M87 10h1M91 10h1M1 11h1M14 11h1M22 11h1M31 11h1M34 11h1M38 11h1M40 11h1M43 11h1M46 11h1M55 11h1M58 11h1M67 11h1M70 11h1M75 11h1M79 11h1M82 11h1M87 11h1M91 11h1M1 12h1M14 12h1M22 12h10M34 12h10M46 12h10M58 12h10M70 12h10M82 12h10M2 13h2M12 13h2M4 14h2M10 14h2M6 15h4"></path>
  <path stroke="#26C6DA" d="M4 1h2M11 1h2M3 2h3M10 2h3M3 3h1M5 3h2M10 3h1M12 3h2M2 4h2M6 4h2M9 4h2M13 4h1M2 5h1M7 5h2M13 5h1M1 6h2M8 6h3M13 6h2M2 7h1M10 7h3M12 8h1"></path>
  <path stroke="#3CCCDE" d="M4 3h1M11 3h1M4 4h2M11 4h2M3 5h4M11 5h2M3 6h1M6 6h2M3 7h1M7 7h3M10 8h2M11 9h1"></path>
  <path stroke="#FAFAFA" d="M23 4h7M35 4h4M40 4h2M47 4h7M59 4h4M71 4h4M76 4h2M83 4h7M23 5h8M35 5h4M40 5h3M47 5h8M59 5h4M71 5h4M76 5h3M83 5h8M23 6h8M35 6h4M40 6h3M47 6h8M59 6h4M71 6h4M76 6h3M83 6h8M23 7h8M35 7h4M40 7h3M47 7h8M59 7h4M71 7h4M76 7h3M83 7h8M23 8h5M35 8h4M40 8h3M47 8h4M52 8h3M59 8h4M71 8h4M76 8h3M83 8h4M88 8h3M23 9h8M35 9h4M40 9h3M47 9h4M52 9h3M59 9h4M71 9h7M83 9h8M28 10h3M35 10h8M47 10h4M52 10h3M59 10h4M64 10h3M71 10h4M76 10h3M83 10h4M88 10h3M23 11h8M35 11h3M39 11h1M41 11h2M47 11h8M59 11h8M71 11h4M76 11h3M83 11h4M88 11h3"></path>
  <path stroke="#51D1E2" d="M4 6h2M4 7h3M4 8h1M6 8h2"></path>
  <path stroke="#212121" d="M1 8h1M1 9h3M1 10h4M2 11h3M2 12h3M4 13h2"></path>
  <path stroke="#67D7E6" d="M5 8h1M5 9h1"></path>
  <path stroke="#424242" d="M14 8h1M13 9h2M13 10h2"></path>
  <path stroke="#323232" d="M8 9h2M8 10h3M8 11h3M9 12h2M9 13h3"></path>
  <path stroke="#292929" d="M6 10h2M5 11h3M5 12h4M6 13h3M6 14h4"></path>
  <path stroke="#3A3A3A" d="M12 10h1M11 11h3M11 12h3"></path>
</svg>

        </div>
      </a>
    </div>
    <div class="ml-4">
      <div class="sm:flex hidden hover:text-gray-500">
        
          <a class="flex items-center h-18 px-4 hover:text-gray-50" href="https://smolka.dev/about">
            
            <div class="relative inline-flex flex-col justify-center h-full">
              <span>About</span>
              <span class="absolute bottom-0 h-0 w-full bg-gray-50"></span>
            </div>
          </a>
        
          <a class="flex items-center h-18 px-4 hover:text-gray-50" href="https://smolka.dev/cycling">
            
            <div class="relative inline-flex flex-col justify-center h-full">
              <span>Cycling</span>
              <span class="absolute bottom-0 h-0 w-full bg-gray-50"></span>
            </div>
          </a>
        
          <a class="flex items-center h-18 px-4 hover:text-gray-50" href="https://smolka.dev/eggvance">
            
            <div class="relative inline-flex flex-col justify-center h-full">
              <span>Eggvance</span>
              <span class="absolute bottom-0 nav-item-animation h-1 w-full bg-gray-50"></span>
            </div>
          </a>
        
      </div>
      <div class="flex sm:hidden">
        <button :class="{ 'is-active': menu }" @click="menu = !menu" class="hamburger hamburger--squeeze h-18 focus:outline-none">
          <span class="hamburger-box align-middle">
            <span class="hamburger-inner"></span>
          </span>
        </button>
      </div>
    </div>
  </nav>
</header>
<div class="aboslute top-0 min-h-18 w-full bg-gray-900"></div>
<div x-cloak="" x-show="menu" class="mobile-menu block sm:hidden w-full bg-gray-900 text-gray-50 overflow-y-auto shadow-header select-none">
  <div class="flex flex-col mb-4 hover:text-gray-500">
    
      <a class="flex justify-center items-center h-18 hover:text-gray-50" href="https://smolka.dev/about">About</a>
    
      <a class="flex justify-center items-center h-18 hover:text-gray-50" href="https://smolka.dev/cycling">Cycling</a>
    
      <a class="flex justify-center items-center h-18 hover:text-gray-50" href="https://smolka.dev/eggvance">Eggvance</a>
    
  </div>
</div>
<noscript class="w-full px-4 py-3 bg-gray-900 text-gray-50 text-center">
  This site works better with JavaScript enabled (it's just ~10kb).
</noscript>

    
  <div class="w-full px-4 py-8 sm:py-16 bg-gray-900">
    <div class="flex flex-col text-center">
      <span class="max-w-screen-lg mx-auto mb-2 text-gray-50 text-4xl">Progress Report #3</span>
      <span class="max-w-screen-sm mx-auto text-gray-400">The third progress report of the eggvance GBA emulator.</span>
    </div>
  </div>
  <div class="w-full max-w-screen-md mx-auto px-4 py-8 sm:py-16">
    <div class="single">
      <p>This month in an average emulator - a complete rewrite. That's what happens when you aren't satisfied with your project and you have a whole month of spare time. Some parts have been reused but almost every area has been improved to some extent, accuracy and performance-wise.</p>
<h3 id="optimizing-instruction-execution">
  <a href="#optimizing-instruction-execution">Optimizing Instruction Execution</a>
</h3>
<p>The GBA's processor can execute either 16-bit Thumb or 32-bit ARM instructions. Each instruction has a different number of fixed and variable bits. Fixed bits provide information about the used format while variable bits are used to encode parameters like registers, flags and immediate values. As a result of having 16 additional bits, ARM instructions tend to be much more complex and versatile in their nature.</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/thumb-format.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/thumb-format.png" alt="Figure 1 - Thumb format" loading="lazy" width="1498" height="344">
</a>
    
      <figcaption>Figure 1 - Thumb format</figcaption>
    
  </figure>



</div>

<p>Figure 1 shows a small subset of the 19 possible Thumb instruction formats. When looking at them as a whole you will notice that they can be decoded by using the most significant 8 bits. In the previous version of the emulator decoding and executing an instruction where two separate steps. First a static array of enumerations was used to identify the instruction format and then a switch-case executed the matching instruction handler.</p>
<pre class=" language-cpp"><code class=" language-cpp"><span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">ThumbFormat</span> <span class="token punctuation">{</span>
  MoveShiftedRegister<span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> ThumbFormat lut<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token class-name">ARM</span><span class="token operator">::</span><span class="token function">executeThumb</span><span class="token punctuation">(</span><span class="token keyword">u16</span> instr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>lut<span class="token punctuation">[</span>instr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> ThumbFormat<span class="token operator">::</span>MoveShiftedRegister<span class="token operator">:</span>
      <span class="token function">Thumb_MoveShiftedRegister</span><span class="token punctuation">(</span>instr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This approach can be optimized by storing template function pointers inside the array. Flags, registers and immediate values which occur inside the 10 (extended from 8) most significant bits can be passed as template parameters and are therefore optimized by the compiler. Doing this also eliminates the necessity to extract these values later in the instruction handler.</p>
<pre class=" language-cpp"><code class=" language-cpp">std<span class="token operator">::</span>array<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>ARM<span class="token operator">::</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">u16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token operator">&gt;</span> ARM<span class="token operator">::</span>instr_thumb <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">&amp;</span>ARM<span class="token operator">::</span>Thumb_MoveShiftedRegister<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>ARM<span class="token operator">::</span>Thumb_MoveShiftedRegister<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>ARM<span class="token operator">::</span>Thumb_MoveShiftedRegister<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">ARM</span><span class="token operator">::</span><span class="token function">executeThumb</span><span class="token punctuation">(</span><span class="token keyword">u16</span> instr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token operator">*</span>instr_thumb<span class="token punctuation">[</span>instr <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>instr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="initializing-unused-registers">
  <a href="#initializing-unused-registers">Initializing (Unused) Registers</a>
</h3>
<p>At some point in development the emulator was able to boot every tested game apart from the Sonic Advance titles. Resolving issues like this usually involves running my emulator against established ones like No$GBA. After two hours of comparing I ended up noticing that a different value of the RCNT register, which is used for multiplayer functionality, caused a chain of events leading to the screen shown in figure 2.</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/sonic-rcnt-bug.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/sonic-rcnt-bug.png" alt="Figure 2 - Uninitialized RCNT" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 2 - Uninitialized RCNT</figcaption>
    
  </figure>


  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/sonic-rcnt.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/sonic-rcnt.png" alt="Figure 3 - Initalized RCNT" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 3 - Initalized RCNT</figcaption>
    
  </figure>



</div>

<p>This problem was caused by skipping the BIOS and directly jumping inside the ROM. Apart from showing the animated intro sequence, the BIOS also initializes registers like RCNT and DISPCNT to their default value. I knew about this and properly initialized all implemented registers to their post-BIOS state, but RCNT is not, and probably never will be, used in my emulator and was therefore left untouched. Doing a test run with the BIOS could've saved me a couple of hours but that's something I usually don't do during development.</p>
<h3 id="fixing-arithmetic-operations">
  <a href="#fixing-arithmetic-operations">Fixing Arithmetic Operations</a>
</h3>
<p>Running mGBA's <a href="https://github.com/mgba-emu/suite" target="_blank" rel="noopener">test suite</a> made be realize flaws in my carry / overflow detection mechanism for arithmetic operations, which caused sprite flickering bugs in games like Mario Kart. The basic add, subtract and reverse subtract operations were doing fine, but their "[operation] with carry" counterparts resulted in a wrong carry or overflow flag. I found a nice <a href="http://teaching.idallen.com/dat2343/10f/notes/040_overflow.txt" target="_blank" rel="noopener">website</a> which explains overflow detection for basic addition and subtraction.</p>
<pre class=" language-cpp"><code class=" language-cpp"><span class="token keyword">bool</span> <span class="token function">carryAdd</span><span class="token punctuation">(</span><span class="token keyword">u64</span> op1<span class="token punctuation">,</span> <span class="token keyword">u64</span> op2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>op1 <span class="token operator">+</span> op2<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0xFFFF'FFFF</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The function above can be used to check if the addition of two operands results in a carry. Please note that the arguments are 64-bit instead 32-bit integers to prevent overflow during addition or while creating the operand itself. An example for its usage can be seen in the <code>add</code> function.</p>
<pre class=" language-cpp"><code class=" language-cpp"><span class="token keyword">u32</span> <span class="token class-name">ARM</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">u32</span> op1<span class="token punctuation">,</span> <span class="token keyword">u32</span> op2<span class="token punctuation">,</span> <span class="token keyword">bool</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">u32</span> res <span class="token operator">=</span> op1 <span class="token operator">+</span> op2<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cpsr<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">zero</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cpsr<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cpsr<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token function">carryAdd</span><span class="token punctuation">(</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cpsr<span class="token punctuation">.</span>v <span class="token operator">=</span> <span class="token function">overflowAdd</span><span class="token punctuation">(</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">u32</span> <span class="token class-name">ARM</span><span class="token operator">::</span><span class="token function">adc</span><span class="token punctuation">(</span><span class="token keyword">u32</span> op1<span class="token punctuation">,</span> <span class="token keyword">u32</span> op2<span class="token punctuation">,</span> <span class="token keyword">bool</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Wrong, op2 might overflow</span>
  <span class="token keyword">return</span> <span class="token function">add</span><span class="token punctuation">(</span>op1<span class="token punctuation">,</span> op2 <span class="token operator">+</span> cpsr<span class="token punctuation">.</span>c<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The old version of add with carry simply added the carry flag of the status register to the second operand and then called the <code>add</code> function. This worked as expected and didn't produce any major bugs in the tested games. At least that's what I've thought. Imagine passing the maximum 32-bit value to the function and then adding the carry. The value overflows and the flags are calculated with the wrong operands. The result itself will be fine because we just care about the lower 32 bits anyway.</p>
<pre class=" language-cpp"><code class=" language-cpp"><span class="token keyword">u32</span> <span class="token class-name">ARM</span><span class="token operator">::</span><span class="token function">adc</span><span class="token punctuation">(</span><span class="token keyword">u32</span> op1<span class="token punctuation">,</span> <span class="token keyword">u32</span> op2<span class="token punctuation">,</span> <span class="token keyword">bool</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">u64</span> opc <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">u64</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>op2<span class="token punctuation">)</span> <span class="token operator">+</span> cpsr<span class="token punctuation">.</span>c<span class="token punctuation">;</span>
  <span class="token keyword">u32</span> res <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>op1 <span class="token operator">+</span> opc<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cpsr<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">zero</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cpsr<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cpsr<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token function">carryAdd</span><span class="token punctuation">(</span>op1<span class="token punctuation">,</span> opc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cpsr<span class="token punctuation">.</span>v <span class="token operator">=</span> <span class="token function">overflowAdd</span><span class="token punctuation">(</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Using a 64-bit integer to store the second operand with added carry was the first improvement over the standard <code>add</code> function. Sadly this didn't fix all the problems. Comparing my results to the expected results of the mGBA test suite made me realize that the carry flag is only taken into consideration for carry detection and is completely ignored for overflow detection. The code above shows my final <code>adc</code> function (note the usage of <code>opc</code>).</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/mgba-carry-fail.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/mgba-carry-fail.png" alt="Figure 4 - Carry tests fail" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 4 - Carry tests fail</figcaption>
    
  </figure>


  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/mgba-carry-pass.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/mgba-carry-pass.png" alt="Figure 5 - Carry tests pass" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 5 - Carry tests pass</figcaption>
    
  </figure>



</div>

<h3 id="config">
  <a href="#config">Config</a>
</h3>
<p>One thing is really wanted to have in the first release version was a customizable config. In terms of format I decided to go with <a href="https://github.com/toml-lang/toml" target="_blank" rel="noopener">TOML</a> because I really like its general structure and clarity. The config allows the user freely configure keyboard and controller mappings for general input and shortcuts like fullscreen and different emulation speeds. A snippet of the general options is shown below and the full version can be found on <a href="https://github.com/jsmolka/eggvance/blob/f2a1e0311e5467b3b91fa69b6ab4a7ddc292f525/eggvance/eggvance.toml" target="_blank" rel="noopener">GitHub</a>.</p>
<pre class=" language-toml"><code class=" language-toml"><span class="token punctuation">[</span><span class="token table class-name">general</span><span class="token punctuation">]</span>
<span class="token comment"># Relative or absolute BIOS file.</span>
<span class="token key property">bios_file</span> <span class="token punctuation">=</span> <span class="token string">"bios.bin"</span>
<span class="token comment"># Skips the BIOS intro.</span>
<span class="token key property">bios_skip</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
<span class="token comment"># Relative or absolute save directory. An empty</span>
<span class="token comment"># value stores save files next to the ROM.</span>
<span class="token key property">save_dir</span> <span class="token punctuation">=</span> <span class="token string">""</span>
<span class="token comment"># Controller deadzone.</span>
<span class="token key property">deadzone</span> <span class="token punctuation">=</span> <span class="token number">16000</span>
</code></pre>
<h3 id="conclusion">
  <a href="#conclusion">Conclusion</a>
</h3>
<p>That's all for this progress report. A Windows build for the latest version can be found on <a href="https://github.com/jsmolka/eggvance/releases" target="_blank" rel="noopener">GitHub</a>. I used profile guided optimization to squeeze out the last drop of performance (most games can be played at 10x the normal speed). Of course the current version is not perfect and bug free, audio is still missing and there are crashes and visual bugs in a few games like DOOM II.</p>
<div class="flex flex-col sm:flex-row justify-center w-full my-6">
  
  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/doom-bug-1.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/doom-bug-1.png" alt="Figure 6 - DOOM II bug" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 6 - DOOM II bug</figcaption>
    
  </figure>


  
  
  

  <figure class="ml-0 mt-6 sm:ml-6 sm:mt-0 first:ml-0 first:mt-0 ">
    <a href="/static/img/eggvance/doom-bug-2.png" target="_blank">
  <img class="w-full" src="/static/img/eggvance/doom-bug-2.png" alt="Figure 7 - DOOM II bug" loading="lazy" width="482" height="352">
</a>
    
      <figcaption>Figure 7 - DOOM II bug</figcaption>
    
  </figure>



</div>


    </div>
    <div class="flex justify-between mt-6 pt-6 text-sm text-gray-500 border-t border-gray-300">
      <span class="inline-flex items-center">
        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="currentColor" d="M17 3h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2v2h6V1h2v2zm-2 2H9v2H7V5H4v4h16V5h-3v2h-2V5zm5 6H4v8h16v-8z"></path>
        </svg>
        <span>
          
            2019-11-03
          
        </span>
      </span>
      <a class="inline-flex items-center" href="https://github.com/jsmolka/jsmolka.github.io/tree/master/content/eggvance/progress-3.md" target="_blank">
        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="currentColor" d="M7.05 14.121L4.93 16.243l2.828 2.828L19.071 7.757 16.243 4.93 14.12 7.05l1.415 1.414L14.12 9.88l-1.414-1.415-1.414 1.415 1.414 1.414-1.414 1.414-1.414-1.414-1.415 1.414 1.415 1.414-1.415 1.415L7.05 14.12zm9.9-11.313l4.242 4.242a1 1 0 0 1 0 1.414L8.464 21.192a1 1 0 0 1-1.414 0L2.808 16.95a1 1 0 0 1 0-1.414L15.536 2.808a1 1 0 0 1 1.414 0zM14.12 18.363l1.415-1.414 2.242 2.243h1.414v-1.414l-2.242-2.243 1.414-1.414L21 16.757V21h-4.242l-2.637-2.637zM5.636 9.878L2.807 7.05a1 1 0 0 1 0-1.415l2.829-2.828a1 1 0 0 1 1.414 0L9.88 5.635 8.464 7.05 6.343 4.928 4.929 6.343l2.121 2.12-1.414 1.415z"></path>
        </svg>
        <span>Improve</span>
      </a>
    </div>
  </div>

  

</body></html>